# 真实支付接口集成完整指南

## 🎯 目标：集成微信支付 + 支付宝支付

## 📋 第一阶段：资质申请（1-3个工作日）

### 1.1 微信支付申请
**访问地址：** https://pay.weixin.qq.com

**所需材料：**
- ✅ 营业执照（个体工商户也可）
- ✅ 法人身份证正反面照片
- ✅ 对公银行账户（或法人个人银行卡）
- ✅ 经营场所照片（门头+内景）
- ✅ 已备案的域名和网站

**申请步骤：**
1. 注册微信支付商户账号
2. 提交资质审核（1-2个工作日）
3. 获取商户号（MchID）
4. 设置API密钥和APIv3密钥
5. 下载API证书

### 1.2 支付宝申请
**访问地址：** https://open.alipay.com

**所需材料：**
- ✅ 营业执照
- ✅ 法人身份证
- ✅ 对公账户
- ✅ 已备案的域名
- ✅ 网站必须HTTPS

**申请步骤：**
1. 注册支付宝开放平台账号
2. 创建应用并提交审核
3. 获取AppID
4. 配置应用公钥和支付宝公钥
5. 开通手机网站支付和电脑网站支付

## 📋 第二阶段：服务器准备（1天）

### 2.1 购买域名和服务器
```bash
推荐配置：
- 域名：已备案的.com/.cn域名
- 服务器：阿里云/腾讯云 2核4G 以上
- 系统：Ubuntu 20.04 LTS
- SSL证书：免费Let's Encrypt
- 价格：约￥50-100/月
```

### 2.2 环境配置
```bash
# 连接服务器
ssh root@你的服务器IP

# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装必要软件
sudo apt install nginx nodejs npm mysql-server certbot python3-certbot-nginx

# 安装Node.js 18.x
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装PM2进程管理器
sudo npm install -g pm2
```

### 2.3 配置Nginx
```nginx
# /etc/nginx/sites-available/your-domain.com
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;

    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    root /var/www/your-domain.com;
    index index.html index.htm;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

## 📋 第三阶段：后端API开发（2-3天）

### 3.1 项目初始化
```bash
# 在服务器上创建项目目录
mkdir -p /var/www/your-domain.com/server
cd /var/www/your-domain.com/server

# 初始化项目
npm init -y

# 安装依赖
npm install express cors body-parser axios alipay-sdk crypto mysql2 dotenv
```

### 3.2 配置文件
创建 `.env` 文件：
```env
# 数据库配置
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=你的数据库密码
DB_NAME=payment_system

# 微信支付配置
WECHAT_APP_ID=你的微信AppID
WECHAT_MCH_ID=你的商户号
WECHAT_API_KEY=你的API密钥
WECHAT_SECRET=你的AppSecret

# 支付宝配置
ALIPAY_APP_ID=你的支付宝AppID
ALIPAY_PRIVATE_KEY=你的应用私钥
ALIPAY_PUBLIC_KEY=支付宝公钥

# 服务器配置
BASE_URL=https://your-domain.com
PORT=3000
```

### 3.3 数据库结构
```sql
CREATE DATABASE IF NOT EXISTS payment_system;
USE payment_system;

CREATE TABLE orders (
    id INT AUTO_INCREMENT PRIMARY KEY,
    order_id VARCHAR(50) UNIQUE NOT NULL,
    service_type ENUM('annualReport', 'licenseCancel') NOT NULL,
    amount INT NOT NULL,
    company_name VARCHAR(255),
    credit_code VARCHAR(50),
    contact_person VARCHAR(50),
    contact_phone VARCHAR(20),
    email VARCHAR(100),
    address TEXT,
    payment_method ENUM('wechat', 'alipay'),
    payment_status ENUM('pending', 'paid', 'failed') DEFAULT 'pending',
    transaction_id VARCHAR(100),
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_order_id (order_id),
    INDEX idx_create_time (create_time)
);
```

## 📋 第四阶段：前端集成（1天）

### 4.1 修改支付页面
创建 `payment-real.js`：

```javascript
// 真实支付接口
class RealPayment {
    constructor() {
        this.baseURL = 'https://your-domain.com/api';
    }

    async createWechatOrder(serviceType, amount) {
        const orderId = 'ORDER_' + Date.now();
        
        try {
            const response = await fetch(`${this.baseURL}/payment/wechat/create-order`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    serviceType: serviceType,
                    amount: amount * 100, // 转换为分
                    orderId: orderId
                })
            });

            const result = await response.json();
            return result;
        } catch (error) {
            console.error('微信支付下单失败:', error);
            throw error;
        }
    }

    async createAlipayOrder(serviceType, amount) {
        const orderId = 'ORDER_' + Date.now();
        
        try {
            const response = await fetch(`${this.baseURL}/payment/alipay/create-order`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    serviceType: serviceType,
                    amount: amount * 100, // 转换为分
                    orderId: orderId
                })
            });

            const result = await response.json();
            return result;
        } catch (error) {
            console.error('支付宝下单失败:', error);
            throw error;
        }
    }

    async checkOrderStatus(orderId) {
        try {
            const response = await fetch(`${this.baseURL}/payment/query/${orderId}`);
            const result = await response.json();
            return result;
        } catch (error) {
            console.error('查询订单失败:', error);
            throw error;
        }
    }
}
```

### 4.2 支付二维码显示
```javascript
function showQRCode(qrCode, type, orderId) {
    const modal = document.createElement('div');
    modal.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 30px; border-radius: 10px; text-align: center;">
                <h3>请使用${type === 'wechat' ? '微信' : '支付宝'}扫码支付</h3>
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrCode)}" alt="支付二维码">
                <p>订单号：${orderId}</p>
                <button onclick="this.parentElement.parentElement.remove()">取消支付</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}
```

## 📋 第五阶段：测试部署（1天）

### 5.1 部署后端
```bash
# 上传代码到服务器
cd /var/www/your-domain.com/server

# 创建PM2配置文件
echo 'module.exports = {
  apps: [{
    name: "payment-api",
    script: "./app.js",
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: "1G",
    env: {
      NODE_ENV: "production",
      PORT: 3000
    }
  }]
};' > ecosystem.config.js

# 启动服务
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

### 5.2 测试流程
1. **微信支付测试**
   - 创建测试订单
   - 扫码支付测试
   - 回调验证

2. **支付宝测试**
   - 创建测试订单
   - 扫码支付测试
   - 回调验证

3. **订单查询测试**
   - 支付状态查询
   - 订单详情查询

## 💰 费用清单

| 项目 | 费用 | 备注 |
|------|------|------|
| 域名注册 | ¥50-100/年 | .com域名 |
| 云服务器 | ¥50-100/月 | 2核4G配置 |
| SSL证书 | 免费 | Let's Encrypt |
| 微信支付 | 0.6%手续费 | 每笔交易费率 |
| 支付宝 | 0.6%手续费 | 每笔交易费率 |

## ⚠️ 注意事项

1. **安全性**
   - 所有接口必须使用HTTPS
   - 敏感信息必须加密存储
   - 定期更新API密钥

2. **合规性**
   - 确保网站已备案
   - 遵守支付平台规则
   - 保留交易记录

3. **监控**
   - 设置支付失败告警
   - 监控服务器状态
   - 定期检查日志

## 🚀 下一步

完成以上步骤后，你将拥有：
- ✅ 真实的微信支付功能
- ✅ 真实的支付宝支付功能
- ✅ 完整的订单管理系统
- ✅ 安全的支付环境

预计总耗时：**5-7个工作日**
预计总费用：**¥500-1000**（首年）
