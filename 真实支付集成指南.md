# çœŸå®æ”¯ä»˜æ¥å£é›†æˆå®Œæ•´æŒ‡å—

## ğŸ¯ ç›®æ ‡ï¼šé›†æˆå¾®ä¿¡æ”¯ä»˜ + æ”¯ä»˜å®æ”¯ä»˜

## ğŸ“‹ ç¬¬ä¸€é˜¶æ®µï¼šèµ„è´¨ç”³è¯·ï¼ˆ1-3ä¸ªå·¥ä½œæ—¥ï¼‰

### 1.1 å¾®ä¿¡æ”¯ä»˜ç”³è¯·
**è®¿é—®åœ°å€ï¼š** https://pay.weixin.qq.com

**æ‰€éœ€ææ–™ï¼š**
- âœ… è¥ä¸šæ‰§ç…§ï¼ˆä¸ªä½“å·¥å•†æˆ·ä¹Ÿå¯ï¼‰
- âœ… æ³•äººèº«ä»½è¯æ­£åé¢ç…§ç‰‡
- âœ… å¯¹å…¬é“¶è¡Œè´¦æˆ·ï¼ˆæˆ–æ³•äººä¸ªäººé“¶è¡Œå¡ï¼‰
- âœ… ç»è¥åœºæ‰€ç…§ç‰‡ï¼ˆé—¨å¤´+å†…æ™¯ï¼‰
- âœ… å·²å¤‡æ¡ˆçš„åŸŸåå’Œç½‘ç«™

**ç”³è¯·æ­¥éª¤ï¼š**
1. æ³¨å†Œå¾®ä¿¡æ”¯ä»˜å•†æˆ·è´¦å·
2. æäº¤èµ„è´¨å®¡æ ¸ï¼ˆ1-2ä¸ªå·¥ä½œæ—¥ï¼‰
3. è·å–å•†æˆ·å·ï¼ˆMchIDï¼‰
4. è®¾ç½®APIå¯†é’¥å’ŒAPIv3å¯†é’¥
5. ä¸‹è½½APIè¯ä¹¦

### 1.2 æ”¯ä»˜å®ç”³è¯·
**è®¿é—®åœ°å€ï¼š** https://open.alipay.com

**æ‰€éœ€ææ–™ï¼š**
- âœ… è¥ä¸šæ‰§ç…§
- âœ… æ³•äººèº«ä»½è¯
- âœ… å¯¹å…¬è´¦æˆ·
- âœ… å·²å¤‡æ¡ˆçš„åŸŸå
- âœ… ç½‘ç«™å¿…é¡»HTTPS

**ç”³è¯·æ­¥éª¤ï¼š**
1. æ³¨å†Œæ”¯ä»˜å®å¼€æ”¾å¹³å°è´¦å·
2. åˆ›å»ºåº”ç”¨å¹¶æäº¤å®¡æ ¸
3. è·å–AppID
4. é…ç½®åº”ç”¨å…¬é’¥å’Œæ”¯ä»˜å®å…¬é’¥
5. å¼€é€šæ‰‹æœºç½‘ç«™æ”¯ä»˜å’Œç”µè„‘ç½‘ç«™æ”¯ä»˜

## ğŸ“‹ ç¬¬äºŒé˜¶æ®µï¼šæœåŠ¡å™¨å‡†å¤‡ï¼ˆ1å¤©ï¼‰

### 2.1 è´­ä¹°åŸŸåå’ŒæœåŠ¡å™¨
```bash
æ¨èé…ç½®ï¼š
- åŸŸåï¼šå·²å¤‡æ¡ˆçš„.com/.cnåŸŸå
- æœåŠ¡å™¨ï¼šé˜¿é‡Œäº‘/è…¾è®¯äº‘ 2æ ¸4G ä»¥ä¸Š
- ç³»ç»Ÿï¼šUbuntu 20.04 LTS
- SSLè¯ä¹¦ï¼šå…è´¹Let's Encrypt
- ä»·æ ¼ï¼šçº¦ï¿¥50-100/æœˆ
```

### 2.2 ç¯å¢ƒé…ç½®
```bash
# è¿æ¥æœåŠ¡å™¨
ssh root@ä½ çš„æœåŠ¡å™¨IP

# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£…å¿…è¦è½¯ä»¶
sudo apt install nginx nodejs npm mysql-server certbot python3-certbot-nginx

# å®‰è£…Node.js 18.x
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# å®‰è£…PM2è¿›ç¨‹ç®¡ç†å™¨
sudo npm install -g pm2
```

### 2.3 é…ç½®Nginx
```nginx
# /etc/nginx/sites-available/your-domain.com
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;

    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    root /var/www/your-domain.com;
    index index.html index.htm;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

## ğŸ“‹ ç¬¬ä¸‰é˜¶æ®µï¼šåç«¯APIå¼€å‘ï¼ˆ2-3å¤©ï¼‰

### 3.1 é¡¹ç›®åˆå§‹åŒ–
```bash
# åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºé¡¹ç›®ç›®å½•
mkdir -p /var/www/your-domain.com/server
cd /var/www/your-domain.com/server

# åˆå§‹åŒ–é¡¹ç›®
npm init -y

# å®‰è£…ä¾èµ–
npm install express cors body-parser axios alipay-sdk crypto mysql2 dotenv
```

### 3.2 é…ç½®æ–‡ä»¶
åˆ›å»º `.env` æ–‡ä»¶ï¼š
```env
# æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=ä½ çš„æ•°æ®åº“å¯†ç 
DB_NAME=payment_system

# å¾®ä¿¡æ”¯ä»˜é…ç½®
WECHAT_APP_ID=ä½ çš„å¾®ä¿¡AppID
WECHAT_MCH_ID=ä½ çš„å•†æˆ·å·
WECHAT_API_KEY=ä½ çš„APIå¯†é’¥
WECHAT_SECRET=ä½ çš„AppSecret

# æ”¯ä»˜å®é…ç½®
ALIPAY_APP_ID=ä½ çš„æ”¯ä»˜å®AppID
ALIPAY_PRIVATE_KEY=ä½ çš„åº”ç”¨ç§é’¥
ALIPAY_PUBLIC_KEY=æ”¯ä»˜å®å…¬é’¥

# æœåŠ¡å™¨é…ç½®
BASE_URL=https://your-domain.com
PORT=3000
```

### 3.3 æ•°æ®åº“ç»“æ„
```sql
CREATE DATABASE IF NOT EXISTS payment_system;
USE payment_system;

CREATE TABLE orders (
    id INT AUTO_INCREMENT PRIMARY KEY,
    order_id VARCHAR(50) UNIQUE NOT NULL,
    service_type ENUM('annualReport', 'licenseCancel') NOT NULL,
    amount INT NOT NULL,
    company_name VARCHAR(255),
    credit_code VARCHAR(50),
    contact_person VARCHAR(50),
    contact_phone VARCHAR(20),
    email VARCHAR(100),
    address TEXT,
    payment_method ENUM('wechat', 'alipay'),
    payment_status ENUM('pending', 'paid', 'failed') DEFAULT 'pending',
    transaction_id VARCHAR(100),
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_order_id (order_id),
    INDEX idx_create_time (create_time)
);
```

## ğŸ“‹ ç¬¬å››é˜¶æ®µï¼šå‰ç«¯é›†æˆï¼ˆ1å¤©ï¼‰

### 4.1 ä¿®æ”¹æ”¯ä»˜é¡µé¢
åˆ›å»º `payment-real.js`ï¼š

```javascript
// çœŸå®æ”¯ä»˜æ¥å£
class RealPayment {
    constructor() {
        this.baseURL = 'https://your-domain.com/api';
    }

    async createWechatOrder(serviceType, amount) {
        const orderId = 'ORDER_' + Date.now();
        
        try {
            const response = await fetch(`${this.baseURL}/payment/wechat/create-order`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    serviceType: serviceType,
                    amount: amount * 100, // è½¬æ¢ä¸ºåˆ†
                    orderId: orderId
                })
            });

            const result = await response.json();
            return result;
        } catch (error) {
            console.error('å¾®ä¿¡æ”¯ä»˜ä¸‹å•å¤±è´¥:', error);
            throw error;
        }
    }

    async createAlipayOrder(serviceType, amount) {
        const orderId = 'ORDER_' + Date.now();
        
        try {
            const response = await fetch(`${this.baseURL}/payment/alipay/create-order`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    serviceType: serviceType,
                    amount: amount * 100, // è½¬æ¢ä¸ºåˆ†
                    orderId: orderId
                })
            });

            const result = await response.json();
            return result;
        } catch (error) {
            console.error('æ”¯ä»˜å®ä¸‹å•å¤±è´¥:', error);
            throw error;
        }
    }

    async checkOrderStatus(orderId) {
        try {
            const response = await fetch(`${this.baseURL}/payment/query/${orderId}`);
            const result = await response.json();
            return result;
        } catch (error) {
            console.error('æŸ¥è¯¢è®¢å•å¤±è´¥:', error);
            throw error;
        }
    }
}
```

### 4.2 æ”¯ä»˜äºŒç»´ç æ˜¾ç¤º
```javascript
function showQRCode(qrCode, type, orderId) {
    const modal = document.createElement('div');
    modal.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 30px; border-radius: 10px; text-align: center;">
                <h3>è¯·ä½¿ç”¨${type === 'wechat' ? 'å¾®ä¿¡' : 'æ”¯ä»˜å®'}æ‰«ç æ”¯ä»˜</h3>
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrCode)}" alt="æ”¯ä»˜äºŒç»´ç ">
                <p>è®¢å•å·ï¼š${orderId}</p>
                <button onclick="this.parentElement.parentElement.remove()">å–æ¶ˆæ”¯ä»˜</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}
```

## ğŸ“‹ ç¬¬äº”é˜¶æ®µï¼šæµ‹è¯•éƒ¨ç½²ï¼ˆ1å¤©ï¼‰

### 5.1 éƒ¨ç½²åç«¯
```bash
# ä¸Šä¼ ä»£ç åˆ°æœåŠ¡å™¨
cd /var/www/your-domain.com/server

# åˆ›å»ºPM2é…ç½®æ–‡ä»¶
echo 'module.exports = {
  apps: [{
    name: "payment-api",
    script: "./app.js",
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: "1G",
    env: {
      NODE_ENV: "production",
      PORT: 3000
    }
  }]
};' > ecosystem.config.js

# å¯åŠ¨æœåŠ¡
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

### 5.2 æµ‹è¯•æµç¨‹
1. **å¾®ä¿¡æ”¯ä»˜æµ‹è¯•**
   - åˆ›å»ºæµ‹è¯•è®¢å•
   - æ‰«ç æ”¯ä»˜æµ‹è¯•
   - å›è°ƒéªŒè¯

2. **æ”¯ä»˜å®æµ‹è¯•**
   - åˆ›å»ºæµ‹è¯•è®¢å•
   - æ‰«ç æ”¯ä»˜æµ‹è¯•
   - å›è°ƒéªŒè¯

3. **è®¢å•æŸ¥è¯¢æµ‹è¯•**
   - æ”¯ä»˜çŠ¶æ€æŸ¥è¯¢
   - è®¢å•è¯¦æƒ…æŸ¥è¯¢

## ğŸ’° è´¹ç”¨æ¸…å•

| é¡¹ç›® | è´¹ç”¨ | å¤‡æ³¨ |
|------|------|------|
| åŸŸåæ³¨å†Œ | Â¥50-100/å¹´ | .comåŸŸå |
| äº‘æœåŠ¡å™¨ | Â¥50-100/æœˆ | 2æ ¸4Gé…ç½® |
| SSLè¯ä¹¦ | å…è´¹ | Let's Encrypt |
| å¾®ä¿¡æ”¯ä»˜ | 0.6%æ‰‹ç»­è´¹ | æ¯ç¬”äº¤æ˜“è´¹ç‡ |
| æ”¯ä»˜å® | 0.6%æ‰‹ç»­è´¹ | æ¯ç¬”äº¤æ˜“è´¹ç‡ |

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å®‰å…¨æ€§**
   - æ‰€æœ‰æ¥å£å¿…é¡»ä½¿ç”¨HTTPS
   - æ•æ„Ÿä¿¡æ¯å¿…é¡»åŠ å¯†å­˜å‚¨
   - å®šæœŸæ›´æ–°APIå¯†é’¥

2. **åˆè§„æ€§**
   - ç¡®ä¿ç½‘ç«™å·²å¤‡æ¡ˆ
   - éµå®ˆæ”¯ä»˜å¹³å°è§„åˆ™
   - ä¿ç•™äº¤æ˜“è®°å½•

3. **ç›‘æ§**
   - è®¾ç½®æ”¯ä»˜å¤±è´¥å‘Šè­¦
   - ç›‘æ§æœåŠ¡å™¨çŠ¶æ€
   - å®šæœŸæ£€æŸ¥æ—¥å¿—

## ğŸš€ ä¸‹ä¸€æ­¥

å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œä½ å°†æ‹¥æœ‰ï¼š
- âœ… çœŸå®çš„å¾®ä¿¡æ”¯ä»˜åŠŸèƒ½
- âœ… çœŸå®çš„æ”¯ä»˜å®æ”¯ä»˜åŠŸèƒ½
- âœ… å®Œæ•´çš„è®¢å•ç®¡ç†ç³»ç»Ÿ
- âœ… å®‰å…¨çš„æ”¯ä»˜ç¯å¢ƒ

é¢„è®¡æ€»è€—æ—¶ï¼š**5-7ä¸ªå·¥ä½œæ—¥**
é¢„è®¡æ€»è´¹ç”¨ï¼š**Â¥500-1000**ï¼ˆé¦–å¹´ï¼‰
